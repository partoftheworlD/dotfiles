---
- name: Задать русскую локаль
  lineinfile:
    path: /etc/locale.gen
    regexp: "^{{ item }}"
    line: "{{ item }}"
    state: present
  loop:
    - "ru_RU.UTF-8 UTF-8"
    - "en_US.UTF-8 UTF-8"
  register: locale_gen
  become: yes

- name: Сгенерировать локали
  command: locale-gen
  when: locale_gen_changed is not defined
  become: yes

- name: Получить список процессов для определения DE
  command: ps -e
  register: running_processes
  changed_when: false
  become: no

- name: Определить, используется ли GNOME
  set_fact:
    desktop_is_gnome: "{{ 'gnome-shell' in running_processes.stdout }}"

- name: Определить, используется ли KDE Plasma
  set_fact:
    desktop_is_kde: "{{ 'plasmashell' in running_processes.stdout }}"

- name: "GNOME: Установить русский язык интерфейса для пользователя"
  become_user: "{{ regular_user }}"
  become: no
  command: >
    gsettings set org.gnome.system.locale region 'ru_RU.UTF-8'
  when: desktop_is_gnome
  register: gnome_lang_set

- name: "KDE: Определить версию KDE и команду для kwriteconfig"
  command: kreadconfig5 --version
  register: kde_version_check
  changed_when: false
  failed_when: false
  become: no
  when: desktop_is_kde

- name: "KDE: Установить переменную с командой KDE Config"
  set_fact:
    kde_config_cmd: "{{ 'kwriteconfig6' if kde_version_check.rc == 0 and '6.' in kde_version_check.stdout else 'kwriteconfig5' }}"
  when: desktop_is_kde

- name: "KDE: Настроить язык интерфейса в ~/.config/plasma-localerc"
  become_user: "{{ regular_user }}"
  become: no
  command: >
    {{ kde_config_cmd }} --file plasmalocalerc --group Language --key Language 'ru:en'
  when: desktop_is_kde

- name: "KDE: Настроить язык для новых пользователей"
  lineinfile:
    path: /etc/skel/.config/plasma-localerc
    line: "[Language]\nLanguage=ru:en"
    create: yes
    mode: '0644'
  become: yes
  when: desktop_is_kde

- name: Установить язык интерфейса
  command: localectl set-locale LANG=ru_RU.UTF-8

- name: Настроить pacman
  lineinfile:
    path: /etc/pacman.conf
    regexp: "^{{ item.param }}"
    line: "{{ item.line }}"
    state: present
  become: yes
  loop:
    - { param: "ParallelDownloads", line: "ParallelDownloads = 10" }
    - { param: "Color", line: "Color" }
    - { param: "VerbosePkgLists", line: "VerbosePkgLists" }

- name: Установить reflector
  package:
    name: reflector
    state: present
  become: yes

- name: Сгенерировать список зеркал
  command: >
    reflector --verbose --protocol https,http --latest 50 -n 5
    --sort rate --save /etc/pacman.d/mirrorlist
  args:
    creates: /etc/pacman.d/mirrorlist
  become: yes

- name: Настроить reflector
  lineinfile:
    path: /etc/xdg/reflector/reflector.conf
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  loop:
    - { regexp: '^--protocol', line: '--protocol https,http' }
    - { regexp: '^--sort', line: '--sort rate' }
  become: yes

- name: Полное обновление системы
  command: pacman -Syu --noconfirm
  register: system_upgraded
  become: yes

- name: Установить flatpak
  package:
    name: flatpak
    state: present

- name: Добавить репозиторий Flathub
  command: flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
  register: flathub_add
  changed_when: "'already exists' not in flathub_add.stderr"
  failed_when: flathub_add.rc != 0 and 'already exists' not in flathub_add.stderr

- name: Замаскировать openh264
  command: flatpak mask org.freedesktop.Platform.openh264
  changed_when: false
  become: yes

- name: Восстановить Flatpak
  command: flatpak repair
  changed_when: false

- name: Обновить Flatpak
  command: flatpak update -y
  changed_when: false

- name: Установить fwupd
  package:
    name: fwupd
    state: present
  become: yes

- name: Обновить кеш fwupd
  command: fwupdmgr refresh --force
  changed_when: false
  become: yes

- name: Проверить наличие обновлений прошивок
  command: fwupdmgr get-updates
  register: fwupd_check
  changed_when: false
  failed_when: false

- name: Применить обновления прошивок
  command: fwupdmgr update -y
  when: fwupd_check.rc == 0
  changed_when: true
  become: yes

- name: Установить base-devel и git
  package:
    name:
      - base-devel
      - git
    state: present
  become: yes

- name: Удалить старый каталог yay-bin
  file:
    path: /tmp/yay-bin
    state: absent
  become: yes

- name: Клонировать репозиторий yay-bin
  git:
    repo: https://aur.archlinux.org/yay-bin.git
    dest: /tmp/yay-bin
    version: HEAD
    update: yes
  become: no

- name: Временно разрешить pacman без пароля для пользователя
  lineinfile:
    path: /etc/sudoers.d/10-ansible-pacman
    line: "{{ regular_user }} ALL=(ALL) NOPASSWD: /usr/bin/pacman"
    create: yes
    mode: '0440'
    validate: 'visudo -cf %s'
  become: yes

- name: Собрать и установить yay-bin
  shell: makepkg -si --noconfirm
  args:
    chdir: /tmp/yay-bin
  become: no
  environment:
    PATH: "{{ ansible_facts['env']['PATH'] }}"

- name: Установить основные пакеты
  package:
    name: "{{ pacman_packages }}"
    state: present
  become: yes

- name: Установить пакеты из AUR
  shell: yay -S --noconfirm {{ aur_packages | join(' ') }}
  become_user: "{{ regular_user }}"
  become: no
  when: aur_packages | length > 0
  register: aur_install
  changed_when: "'nothing to do' not in aur_install.stdout"

- name: Установить Flatpak-приложения
  shell: flatpak install -y flathub {{ flatpak_packages | join(' ') }}
  when: flatpak_packages | length > 0
  register: flatpak_install
  changed_when: "'already installed' not in flatpak_install.stdout"

- name: Обновить кеш шрифтов
  command: fc-cache -fv
  changed_when: false

- name: Скопировать конфиг tmux
  copy:
    src: ./files/tmux/.tmux.conf
    dest: "{{ ansible_facts['env']['HOME'] }}/.tmux.conf"
    mode: '0644'
  become: no

- name: Удалить ненужные пакеты
  package:
    name: "{{ remove_packages }}"
    state: absent
  ignore_errors: yes
  become: yes

- name: Перезагрузить конфигурацию systemd
  command: systemctl daemon-reload
  become: yes
  changed_when: false

- name: Включить и запустить системные службы
  command: systemctl enable --now {{ item }}
  loop: "{{ enable_services }}"
  become: yes
  register: service_result
  changed_when: "'Created symlink' in service_result.stdout or 'enabled' in service_result.stdout"
  failed_when:
    - service_result.rc != 0
    - "'Access denied' not in service_result.stderr"
    - "'Failed to enable unit: Access denied' not in service_result.stderr"

- name: Предупреждение о службах, не запущенных из-за прав
  debug:
    msg: "Служба {{ item.item }} не была запущена: {{ item.stderr }}"
  loop: "{{ service_result.results }}"
  loop_control:
    label: "{{ item.item }}"
  when:
    - item is failed
    - "'Access denied' in item.stderr"

- name: Очистить осиротевшие пакеты
  shell: |
    orphans=$(pacman -Qtdq)
    if [ -n "$orphans" ]; then
      pacman -Rsn $orphans --noconfirm
    fi
  changed_when: false
  become: yes

- name: Очистить кеш yay
  command: yay -Sc --noconfirm
  become_user: "{{ regular_user }}"
  become: no
  changed_when: false

- name: Удалить временный файл sudoers
  file:
    path: /etc/sudoers.d/10-ansible-pacman
    state: absent
  become: yes
  when: aur_packages | length > 0

- name: Удалить иконки нежелательных приложений
  shell: |
    files=$(grep -rE "Name=(Avahi|Electron|Qt)" /usr/share/applications/ | awk -F":" '{print $1}')
    if [ -n "$files" ]; then
      rm $files
    fi
  changed_when: false
  become: yes

- name: Сменить shell на fish для пользователя
  user:
    name: "{{ regular_user }}"
    shell: /usr/bin/fish
  become: yes

- name: Создать конфигурационную директорию fish
  file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/fish"
    state: directory
    owner: "{{ regular_user }}"
    group: "{{ regular_user }}"
    mode: '0755'

- name: Скопировать конфиг fish из локального файла
  copy:
    src: files/fish/config.fish
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/fish/config.fish"
    mode: '0644'
  become: no

- name: Применить настройки GNOME
  script:
    cmd: files/gnome/gnome_settings.sh
    executable: /bin/bash
  become_user: "{{ regular_user }}"
  become: no
  when: desktop_is_gnome

- name: Сообщить о необходимости перезагрузки
  debug:
    msg: "Система была обновлена. Рекомендуется перезагрузить компьютер."