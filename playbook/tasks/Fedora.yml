---
- name: Получить список процессов для определения DE
  command: ps -e
  register: running_processes
  changed_when: false
  become: no

- name: Определить, используется ли GNOME
  set_fact:
    desktop_is_gnome: "{{ 'gnome-shell' in running_processes.stdout }}"

- name: Определить, используется ли KDE Plasma
  set_fact:
    desktop_is_kde: "{{ 'plasmashell' in running_processes.stdout }}"

- name: "KDE: Определить версию KDE и команду для kwriteconfig"
  command: kreadconfig5 --version
  register: kde_version_check
  changed_when: false
  failed_when: false
  become: no
  when: desktop_is_kde

- name: Создать резервную копию /etc/dnf/dnf.conf
  copy:
    src: /etc/dnf/dnf.conf
    dest: /etc/dnf/dnf.conf.bak
    remote_src: yes
    backup: no
  become: yes
  changed_when: false

- name: Настроить DNF
  lineinfile:
    path: /etc/dnf/dnf.conf
    line: "{{ item }}"
    state: present
    create: yes
  loop:
    - "max_parallel_downloads=5"
    - "minrate=1M"
    - "fastestmirror=True"
  become: yes

- name: Отключить ненужные репозитории
  command: dnf config-manager setopt {{ item }}.enabled=0
  loop:
    - fedora-cisco-openh264
    - copr:copr.fedorainfracloud.org:phracek:PyCharm
    - rpmfusion-nonfree-nvidia-driver
  become: yes
  register: disable_repos
  changed_when: "'enabled' in disable_repos.stderr"
  failed_when: disable_repos.rc != 0 and 'No such' not in disable_repos.stderr

- name: Установить основные пакеты из списка dnf_packages
  command: >
    dnf install -y --skip-broken --skip-unavailable
    {{ dnf_packages | join(' ') }}
  environment:
    LC_ALL: C
  become: yes
  register: install_result
  until: install_result is success
  retries: 3
  delay: 10
  changed_when: "'Nothing to do.' not in install_result.stdout"

- name: Установить Flatpak
  dnf:
    name: flatpak
    state: present
  become: yes

- name: Добавить репозиторий Flathub
  command: flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
  become: yes
  register: flathub_add
  changed_when: "'flathub' in flathub_add.stdout"

- name: Проверить, существует ли репозиторий fedora
  command: flatpak remotes | grep fedora
  register: fedora_remote_check
  changed_when: false
  failed_when: false
  become: yes

- name: Удалить Fedora Flatpak репозиторий
  command: flatpak remote-delete fedora --force
  become: yes
  when: fedora_remote_check.rc == 0
  register: fedora_remote_delete
  changed_when: fedora_remote_delete.rc == 0

- name: Замаскировать openh264
  command: flatpak mask org.freedesktop.Platform.openh264
  become: yes
  changed_when: false

- name: Восстановить Flatpak
  command: flatpak repair
  become: yes
  changed_when: false

- name: Установить fwupd
  dnf:
    name: fwupd
    state: present
  become: yes

- name: Обновить кеш fwupd
  command: fwupdmgr refresh --force
  become: yes
  changed_when: false
  ignore_errors: yes

- name: Проверить наличие обновлений прошивок
  command: fwupdmgr get-updates
  register: fwupd_check
  changed_when: false
  failed_when: false
  become: yes

- name: Применить обновления прошивок
  command: fwupdmgr update -y
  become: yes
  when: fwupd_check.rc == 0 and 'No updates available' not in fwupd_check.stdout
  register: fwupd_update
  changed_when: true

- name: Установить и включить SSH
  dnf:
    name: openssh-server
    state: present
  become: yes

- name: Включить и запустить sshd
  systemd:
    name: sshd
    enabled: yes
    state: started
  become: yes

- name: Определить версию Fedora
  command: rpm -E %fedora
  register: fedora_version
  changed_when: false

- name: Установить RPM Fusion free репозиторий
  dnf:
    name: "https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-{{ fedora_version.stdout }}.noarch.rpm"
    state: present
    disable_gpg_check: yes
  become: yes

- name: Установить RPM Fusion nonfree репозиторий
  dnf:
    name: "https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-{{ fedora_version.stdout }}.noarch.rpm"
    state: present
    disable_gpg_check: yes
  become: yes

- name: Обновить группу core
  dnf:
    name: "@core"
    state: latest
  become: yes

- name: Заменить ffmpeg-free на ffmpeg
  command: dnf swap ffmpeg-free ffmpeg --allowerasing -y
  environment:
    LC_ALL: C
  become: yes

- name: Обновить группу multimedia
  dnf:
    name: "@multimedia"
    state: latest
    install_weak_deps: no
    exclude: PackageKit-gstreamer-plugin
  become: yes

- name: Установить группу sound-and-video
  dnf:
    name: "@sound-and-video"
    state: present
  become: yes

- name: Проверить установленные пакеты для аппаратного ускорения
  shell: |
    rpm -q mesa-va-drivers >/dev/null 2>&1 && echo "normal_va_installed" || true
    rpm -q mesa-va-drivers-freeworld >/dev/null 2>&1 && echo "freeworld_va_installed" || true
    rpm -q mesa-vdpau-drivers >/dev/null 2>&1 && echo "normal_vdpau_installed" || true
    rpm -q mesa-vdpau-drivers-freeworld >/dev/null 2>&1 && echo "freeworld_vdpau_installed" || true
  register: hwaccel_check
  changed_when: false
  failed_when: false
  become: yes

- name: Установить основные пакеты из списка dnf_packages
  dnf:
    name: "{{ dnf_packages }}"
    state: present
    skip_broken: yes
  become: yes

- name: Установить Flatpak-приложения
  command: flatpak install -y flathub {{ item }}
  loop: "{{ flatpak_packages }}"
  become: yes
  register: flatpak_install
  changed_when: "'already installed' not in flatpak_install.stdout"
  failed_when: flatpak_install.rc != 0 and 'already installed' not in flatpak_install.stderr
  when: flatpak_packages | length > 0

- name: Добавить репозиторий Brave
  dnf:
    name: dnf-plugins-core
    state: present
  become: yes

- name: Установка Brave через официальный скрипт
  shell: curl -fsS https://dl.brave.com/install.sh | sh
  environment:
    LC_ALL: C
  become: yes

- name: Импортировать ключ Microsoft
  rpm_key:
    state: present
    key: https://packages.microsoft.com/keys/microsoft.asc
  become: yes

- name: Добавить репозиторий VSCode
  yum_repository:
    name: code
    description: Visual Studio Code
    baseurl: https://packages.microsoft.com/yumrepos/vscode
    enabled: yes
    gpgcheck: yes
    gpgkey: https://packages.microsoft.com/keys/microsoft.asc
  become: yes

- name: Установить code
  dnf:
    name: code
    state: present
    update_cache: yes
  become: yes

- name: Создать директорию шрифтов
  file:
    path: "{{ ansible_facts['env']['HOME'] }}/.local/share/fonts/ubuntu"
    state: directory
    owner: "{{ regular_user }}"
    group: "{{ regular_user }}"
    mode: '0755'
  become: yes

- name: Скачать шрифты Ubuntu
  get_url:
    url: https://assets.ubuntu.com/v1/0cef8205-ubuntu-font-family-0.83.zip
    dest: /tmp/ubuntu-fonts.zip
    timeout: 30
  become: no

- name: Распаковать шрифты Ubuntu
  unarchive:
    src: /tmp/ubuntu-fonts.zip
    dest: /tmp/
    remote_src: yes
  become: no

- name: Скопировать все ttf файлы в директорию шрифтов
  copy:
    src: /tmp/ubuntu-font-family-0.83/
    dest: "{{ ansible_facts['env']['HOME'] }}/.local/share/fonts/ubuntu/"
    mode: '0644'
    remote_src: yes
  become: no

- name: Обновить кеш шрифтов
  command: fc-cache -fv
  become: no
  changed_when: false

- name: Скопировать конфиг tmux
  copy:
    src: files/tmux/.tmux.conf
    dest: "{{ ansible_facts['env']['HOME'] }}/.tmux.conf"
    backup: yes
    mode: '0644'
  become: no

- name: Удалить ненужные пакеты
  command: >
    dnf remove -y {{ remove_packages | join(' ') }}
  environment:
    LC_ALL: C
  become: yes

- name: Установить SpotX
  shell: timeout 60 bash <(curl -sSL https://spotx-official.github.io/run.sh) -f
  become: yes
  register: spotx_install
  changed_when:
    - "'already been installed' not in spotx_install.stderr"
    - "'✔ Finished' in spotx_install.stdout"
  failed_when:
    - spotx_install.rc not in [0, 124]
    - "'already been installed' not in spotx_install.stderr"

- name: Сменить shell на fish
  user:
    name: "{{ regular_user }}"
    shell: /usr/bin/fish
  become: yes

- name: Создать директорию конфигурации fish
  file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/fish"
    state: directory
    owner: "{{ regular_user }}"
    group: "{{ regular_user }}"
    mode: '0755'
  become: no

- name: Скопировать конфиг fish
  copy:
    src: files/fish/config.fish
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/fish/config.fish"
    owner: "{{ regular_user }}"
    group: "{{ regular_user }}"
    mode: '0644'
    backup: yes
  become: no

- name: Автоудаление ненужных зависимостей
  command: dnf autoremove -y
  become: yes
  changed_when: false

- name: Очистить кеш dnf
  command: dnf clean all
  become: yes
  changed_when: false

- name: Применить настройки GNOME
  script:
    cmd: files/gnome/gnome_settings.sh
    executable: /bin/bash
  become_user: "{{ regular_user }}"
  become: no
  when: desktop_is_gnome

- name: Сообщить о необходимости перезагрузки
  debug:
    msg: "Система была обновлена. Рекомендуется перезагрузить компьютер."