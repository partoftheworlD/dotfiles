---
- name: Получить список процессов для определения DE
  command: ps -e
  register: running_processes
  changed_when: false
  become: no

- name: Определить, используется ли GNOME
  set_fact:
    desktop_is_gnome: "{{ 'gnome-shell' in running_processes.stdout }}"

- name: Определить, используется ли KDE Plasma
  set_fact:
    desktop_is_kde: "{{ 'plasmashell' in running_processes.stdout }}"

- name: "KDE: Определить версию KDE и команду для kwriteconfig"
  command: kreadconfig6 --version
  register: kde_version_check
  changed_when: false
  failed_when: false
  become: no
  when: desktop_is_kde

- name: "KDE: Настроить язык интерфейса в ~/.config/plasma-localerc"
  become_user: "{{ regular_user }}"
  become: no
  shell: >
    kwriteconfig6 --file plasma-localerc --group Language --key Language 'ru:en' &&
    kwriteconfig6 --file plasma-localerc --group Formats --key LANG 'ru_RU.UTF-8' &&
    kwriteconfig6 --file kxkbrc --group Layout --key LayoutList 'us,ru' &&
    kwriteconfig6 --file kxkbrc --group Layout --key Use true &&
    kwriteconfig6 --file kxkbrc --group Layout --key VariantList , &&
    kwriteconfig6 --file kxkbrc --group Layout --key ResetOldOptions true &&
    kwriteconfig6 --file kxkbrc --group Layout --key Options 'kpdl:dotoss,grp:alt_shift_toggle,grp:win_space_toggle'
  when: desktop_is_kde

- name: Определить версию Fedora
  command: rpm -E %fedora
  register: fedora_version
  changed_when: false

- name: Создать резервную копию /etc/dnf/dnf.conf
  copy:
    src: /etc/dnf/dnf.conf
    dest: /etc/dnf/dnf.conf.bak
    remote_src: yes
    backup: no
  become: yes
  changed_when: false

- name: Настроить DNF
  lineinfile:
    path: /etc/dnf/dnf.conf
    line: "{{ item }}"
    state: present
    create: yes
  loop:
    - "max_parallel_downloads=5"
    - "minrate=1M"
    - "fastestmirror=True"
  become: yes

- name: Отключить ненужные репозитории
  command: dnf config-manager setopt {{ item }}.enabled=0
  loop:
    - fedora-cisco-openh264
    - copr:copr.fedorainfracloud.org:phracek:PyCharm
    - rpmfusion-nonfree-nvidia-driver
  become: yes
  register: disable_repos
  failed_when: disable_repos.rc != 0 and 'No such' not in disable_repos.stderr

- name: Установить RPM Fusion free репозиторий
  dnf:
    name: "https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-{{ fedora_version.stdout }}.noarch.rpm"
    state: present
    disable_gpg_check: yes
  become: yes

- name: Установить RPM Fusion nonfree репозиторий
  dnf:
    name: "https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-{{ fedora_version.stdout }}.noarch.rpm"
    state: present
    disable_gpg_check: yes
  become: yes

- name: Обновить систему и установить основные пакеты из списка dnf_packages
  shell: >
    dnf up --refresh -y &&
    dnf install -y --skip-broken --skip-unavailable {{ dnf_packages | join(' ') }}
  environment:
    LC_ALL: C
  become: yes
  register: install_result
  until: install_result is success
  retries: 3
  delay: 10
  changed_when: "'Nothing to do.' not in install_result.stdout"

- name: Добавить Flathub репозиторий
  flatpak_remote:
    name: flathub
    state: present
    flatpakrepo_url: https://dl.flathub.org/repo/flathub.flatpakrepo
    method: user
  when: flatpak_packages | length > 0

- name: Проверить, существует ли репозиторий fedora
  command: flatpak remotes | grep fedora
  register: fedora_remote_exists
  changed_when: false
  failed_when: false
  become: no

- name: Удалить Fedora Flatpak репозиторий
  flatpak_remote:
    name: fedora
    state: absent
    method: system
  become: yes
  when: fedora_remote_exists.rc == 0

- name: Замаскировать openh264
  command: flatpak mask org.freedesktop.Platform.openh264
  become: yes

- name: Восстановить Flatpak
  command: flatpak repair
  become: yes
  changed_when: false

- name: Включить и запустить sshd
  systemd:
    name: sshd
    enabled: yes
    state: started
  become: yes

- name: Обновить группу core
  dnf:
    name: "@core"
    state: latest
  become: yes

- name: Обновить группу multimedia
  dnf:
    name: "@multimedia"
    state: latest
    install_weak_deps: no
    exclude: PackageKit-gstreamer-plugin
  become: yes

- name: Установить группу sound-and-video
  dnf:
    name: "@sound-and-video"
    state: present
  become: yes

- name: Заменить на пакеты из rpm fusion
  command: dnf swap {{ item.from }} {{ item.to }} --allowerasing -y
  register: swap_freeworld
  changed_when: '"Complete!" in swap_freeworld.stdout'
  failed_when: false
  loop: "{{ swap_packages }}"
  loop_control:
    label: "{{ item.from }} -> {{ item.to }}"
  environment:
    LC_ALL: C
  become: yes

- name: Установить Flatpak-приложения
  flatpak:
    name: "{{ flatpak_packages }}"
    state: present
    method: user
  when: flatpak_packages | length > 0

- name: Добавить репозиторий Brave
  dnf:
    name: dnf-plugins-core
    state: present
  become: yes

- name: Установка Brave через официальный скрипт
  shell: curl -fsS https://dl.brave.com/install.sh | sh
  environment:
    LC_ALL: C
  become: yes

- name: Импортировать ключ Microsoft
  rpm_key:
    state: present
    key: https://packages.microsoft.com/keys/microsoft.asc
  become: yes

- name: Добавить репозиторий VSCode
  yum_repository:
    name: code
    description: Visual Studio Code
    baseurl: https://packages.microsoft.com/yumrepos/vscode
    enabled: yes
    gpgcheck: yes
    gpgkey: https://packages.microsoft.com/keys/microsoft.asc
  become: yes

- name: Установить VSCode
  dnf:
    name: code
    state: present
    update_cache: yes
  become: yes

- name: Создать директорию шрифтов
  file:
    path: "{{ ansible_facts['env']['HOME'] }}/.local/share/fonts/ubuntu"
    state: directory
    owner: "{{ regular_user }}"
    group: "{{ regular_user }}"
    mode: '0755'
  become: no

- name: Скачать шрифты Ubuntu
  get_url:
    url: https://assets.ubuntu.com/v1/0cef8205-ubuntu-font-family-0.83.zip
    dest: /tmp/ubuntu-fonts.zip
    timeout: 30
  become: no

- name: Распаковать шрифты Ubuntu
  unarchive:
    src: /tmp/ubuntu-fonts.zip
    dest: /tmp/
    remote_src: yes
  become: no

- name: Скопировать все ttf файлы в директорию шрифтов
  copy:
    src: /tmp/ubuntu-font-family-0.83/
    dest: "{{ ansible_facts['env']['HOME'] }}/.local/share/fonts/ubuntu/"
    mode: '0644'
    remote_src: yes
  become: no

- name: Обновить кеш шрифтов
  command: fc-cache -f
  become: yes
  changed_when: false

- name: Скопировать конфиг tmux
  copy:
    src: files/tmux/.tmux.conf
    dest: "{{ ansible_facts['env']['HOME'] }}/.tmux.conf"
    backup: yes
    mode: '0644'
  become: no

- name: Удалить ненужные пакеты
  command: >
    dnf remove -y {{ remove_packages | join(' ') }}
  environment:
    LC_ALL: C
  become: yes

- name: Установить SpotX
  shell: timeout 60 bash <(curl -sSL https://spotx-official.github.io/run.sh) -f
  become: yes
  register: spotx_install
  changed_when:
    - "'already been installed' not in spotx_install.stderr"
    - "'✔ Finished' in spotx_install.stdout"
  failed_when:
    - spotx_install.rc not in [0, 124]
    - "'already been installed' not in spotx_install.stderr"

- name: Сменить shell на fish
  user:
    name: "{{ regular_user }}"
    shell: /usr/bin/fish
  become: yes

- name: Создать директорию конфигурации fish
  file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/fish"
    state: directory
    owner: "{{ regular_user }}"
    group: "{{ regular_user }}"
    mode: '0755'
  become: no

- name: Скопировать конфиг fish
  copy:
    src: files/fish/config.fish
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/fish/config.fish"
    owner: "{{ regular_user }}"
    group: "{{ regular_user }}"
    mode: '0644'
    backup: yes
  become: no

- name: Установка stable toolchain Rust
  command: rustup toolchain install stable
  become: no

- name: Автоудаление ненужных зависимостей
  command: dnf autoremove -y
  become: yes
  changed_when: false

- name: Очистить кеш dnf
  command: dnf clean all
  become: yes
  changed_when: false

- name: Применить настройки GNOME
  script:
    cmd: files/gnome/gnome_settings.sh
    executable: /bin/bash
  become_user: "{{ regular_user }}"
  become: no
  when: desktop_is_gnome

- name: Сообщить о необходимости перезагрузки
  debug:
    msg: "Система была обновлена. Рекомендуется перезагрузить компьютер."